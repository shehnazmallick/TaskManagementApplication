<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TaskManagementApplication</a> &gt; <a href="index.source.html" class="el_package">com.encora.taskmanagementapplication.controller</a> &gt; <span class="el_source">AuthController.java</span></div><h1>AuthController.java</h1><pre class="source lang-java linenums">package com.encora.taskmanagementapplication.controller;

import com.encora.taskmanagementapplication.dto.AuthRequest;
import com.encora.taskmanagementapplication.dto.AuthResponse;
import com.encora.taskmanagementapplication.dto.RefreshTokenRequest;
import com.encora.taskmanagementapplication.entity.User;
import com.encora.taskmanagementapplication.exception.AuthException;
import com.encora.taskmanagementapplication.service.RefreshTokenService;
import com.encora.taskmanagementapplication.service.UserService;
import com.encora.taskmanagementapplication.util.JwtUtil;
import io.github.bucket4j.Bucket;
import lombok.SneakyThrows;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseCookie;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;
import com.encora.taskmanagementapplication.entity.RefreshToken;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping(&quot;/api/auth&quot;)
public class AuthController {

    private final JwtUtil jwtUtil;
    private final UserService userService;
    private final Bucket bucket;
    private RefreshTokenService refreshTokenService;

<span class="fc" id="L36">    public AuthController(JwtUtil jwtUtil, UserService userService, Bucket bucket, RefreshTokenService refreshTokenService) {</span>
<span class="fc" id="L37">        this.jwtUtil = jwtUtil;</span>
<span class="fc" id="L38">        this.userService = userService;</span>
<span class="fc" id="L39">        this.bucket = bucket;</span>
<span class="fc" id="L40">        this.refreshTokenService = refreshTokenService;</span>

<span class="fc" id="L42">    }</span>

    @PostMapping(&quot;/refreshtoken&quot;)
    public Mono&lt;ResponseEntity&lt;String&gt;&gt; refreshToken(@RequestBody RefreshTokenRequest request) {
<span class="fc" id="L46">        String requestRefreshToken = request.getRefreshToken();</span>
<span class="fc" id="L47">        return Mono.justOrEmpty(refreshTokenService.findByToken(requestRefreshToken))</span>
<span class="fc" id="L48">                .flatMap(refreshToken -&gt; { // Use flatMap to handle the error within the stream</span>
                    try {
<span class="fc" id="L50">                        RefreshToken verifiedToken = refreshTokenService.verifyExpiration(refreshToken);</span>
<span class="fc" id="L51">                        String token = jwtUtil.generateToken(verifiedToken.getUser().getEmail());</span>
<span class="fc" id="L52">                        return Mono.just(ResponseEntity.ok(token));</span>
<span class="fc" id="L53">                    } catch (AuthException e) {</span>
<span class="fc" id="L54">                        return Mono.just(ResponseEntity.status(HttpStatus.FORBIDDEN).body(e.getMessage()));</span>
                    }
                })
<span class="fc" id="L57">                .switchIfEmpty(Mono.just(ResponseEntity.status(HttpStatus.FORBIDDEN)</span>
<span class="fc" id="L58">                        .body(&quot;Refresh token is not in database!&quot;)));</span>
    }

    @PostMapping(&quot;/login&quot;)
    public Mono&lt;ResponseEntity&lt;?&gt;&gt; generateToken(@RequestBody AuthRequest authRequest) {
<span class="fc" id="L63">        boolean probe = bucket.tryConsume(1);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if (probe) {</span>
<span class="fc" id="L65">            Long userId = userService.validateUser(authRequest.getUsername(), authRequest.getPassword());</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">            if (userId != null) {</span>
<span class="fc" id="L67">                String token = jwtUtil.generateToken(authRequest.getUsername());</span>
<span class="fc" id="L68">                User user = userService.getUserById(userId);</span>
<span class="fc" id="L69">                AuthResponse response = AuthResponse.builder()</span>
<span class="fc" id="L70">                        .token(token)</span>
<span class="fc" id="L71">                        .userName(user.getFirstName() + &quot; &quot; + user.getLastName())</span>
<span class="fc" id="L72">                        .userSettings(user.getUserSettings())</span>
<span class="fc" id="L73">                        .build();</span>
<span class="fc" id="L74">                return Mono.just(ResponseEntity.ok(response));</span>
            } else {
<span class="fc" id="L76">                return Mono.just(ResponseEntity.status(HttpStatus.UNAUTHORIZED).build());</span>
            }
        } else {
<span class="fc" id="L79">            return Mono.just(ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(&quot;Too many requests!&quot;));</span>
        }
    }

     @PostMapping(&quot;/signup&quot;)
     public ResponseEntity&lt;Map&lt;String, String&gt;&gt; signup(@RequestBody Map&lt;String, String&gt; request) {
<span class="fc" id="L85">         String username = request.get(&quot;username&quot;);</span>
<span class="fc" id="L86">         String password = request.get(&quot;password&quot;);</span>
<span class="fc" id="L87">         String firstName = request.get(&quot;firstName&quot;);</span>
<span class="fc" id="L88">         String lastName = request.get(&quot;lastName&quot;);</span>

<span class="fc" id="L90">         Map&lt;String, String&gt; errors = validate(username, password);</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">         if (!errors.isEmpty()) {</span>
<span class="fc" id="L92">             return ResponseEntity.badRequest().body(errors);</span>
         }
<span class="fc" id="L94">         userService.createUser(username, password, firstName, lastName);</span>
<span class="fc" id="L95">         return ResponseEntity.status(HttpStatus.CREATED).body(Map.of(&quot;message&quot;, &quot;User registered successfully!&quot;));</span>
     }

    @PostMapping(&quot;/logout&quot;)
    public ResponseEntity&lt;String&gt; logout(ServerWebExchange exchange) {
<span class="fc" id="L100">        ResponseCookie cookie = ResponseCookie.from(&quot;token&quot;, &quot;&quot;)</span>
<span class="fc" id="L101">                .maxAge(0)</span>
<span class="fc" id="L102">                .path(&quot;/&quot;)</span>
<span class="fc" id="L103">                .httpOnly(true)</span>
<span class="fc" id="L104">                .secure(true) // Set to true if using HTTPS</span>
<span class="fc" id="L105">                .build();</span>
        // Add the cookie to the response
<span class="fc" id="L107">        exchange.getResponse().addCookie(cookie);</span>
<span class="fc" id="L108">        return ResponseEntity.ok(&quot;Logged out successfully&quot;);</span>
    }

    private Map&lt;String, String&gt; validate(String username, String password) {
<span class="fc" id="L112">        Map&lt;String, String&gt; errors = new HashMap&lt;&gt;();</span>

        // Email validation
<span class="pc bpc" id="L115" title="1 of 4 branches missed.">        if (username == null || !username.matches(&quot;.+@.+\\..+&quot;)) {</span>
<span class="fc" id="L116">            errors.put(&quot;username&quot;, &quot;Please enter a valid email address.&quot;);</span>
        }

        // Password validation
<span class="pc bpc" id="L120" title="1 of 4 branches missed.">        if (password == null || password.length() &lt; 8</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">                || !password.matches(&quot;.*[A-Z].*&quot;)</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">                || !password.matches(&quot;.*[0-9].*&quot;)</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">                || !password.matches(&quot;.*[^A-Za-z0-9].*&quot;)) {</span>
<span class="fc" id="L124">            errors.put(&quot;password&quot;, &quot;Password must be at least 8 characters long and contain at least one uppercase letter, one number, and one special character.&quot;);</span>
        }

<span class="fc" id="L127">        return errors;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>